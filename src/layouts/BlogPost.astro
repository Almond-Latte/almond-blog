---
import { Image } from 'astro:assets';
import type { CollectionEntry } from 'astro:content';
import BaseHead from '../components/BaseHead.astro';
import BudouX from '../components/BudouX.astro';
import Footer from '../components/Footer.astro';
import FormattedDate from '../components/FormattedDate.astro';
import Header from '../components/Header.astro';

interface Heading {
	depth: number;
	slug: string;
	text: string;
}

type Props = CollectionEntry<'blog'>['data'] & {
	headings?: Heading[];
};

const { title, description, pubDate, updatedDate, heroImage, headings = [] } = Astro.props;
---

<html lang="en">
	<head>
		<BaseHead title={title} description={description} image={`/og/${Astro.url.pathname.replace('/blog/', '').replace('/', '')}.png`} />
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" crossorigin="anonymous">
		<style>
			main {
				width: 100%;
				max-width: 100%;
				margin: 0;
				padding: 1em;
			}
			.container {
				max-width: 720px;
				width: 100%;
				margin: 0 auto;
				box-sizing: border-box;
			}
			article {
				max-width: 720px;
				min-width: 0;
			}
			.hero-image {
				max-width: 720px;
				margin: 0 auto;
			}
			.hero-image img {
				display: block;
				margin: 0 auto;
				border-radius: 12px;
				box-shadow: var(--box-shadow);
			}
			.prose {
				padding: 1em;
				color: rgb(var(--gray-dark));
			}
			.title {
				max-width: 720px;
				margin: 0 auto 1em;
				padding: 1em 0;
				text-align: center;
				line-height: 1;
			}
			.title h1 {
				margin: 0 0 0.5em 0;
			}
			.date {
				margin-bottom: 0.5em;
				color: rgb(var(--gray));
			}
			.last-updated-on {
				font-style: italic;
			}
			.prose h1 {
				font-size: 1.8em;
			}
			.prose h2 {
				font-size: 1.5em;
			}
			.prose h3 {
				font-size: 1.25em;
			}
			.title :global(h1) {
				font-size: 2em;
			}
			.toc {
				width: 300px;
				flex-shrink: 0;
				display: none;
				position: sticky;
				top: 5em;
				height: fit-content;
			}
			.toc nav {
				background: rgba(var(--gray-light), 0.5);
				border-radius: 8px;
				padding: 1em;
			}
			.toc h2 {
				font-size: 0.875em;
				font-weight: 700;
				text-transform: uppercase;
				letter-spacing: 0.05em;
				margin-bottom: 0.75em;
				color: rgb(var(--gray));
				border-bottom: 1px solid rgba(var(--gray), 0.2);
				padding-bottom: 0.5em;
			}
			.toc ul {
				list-style: none;
				padding: 0;
				margin: 0;
				position: relative;
			}
			.toc ul::before {
				content: '';
				position: absolute;
				left: 6px;
				top: 0.5em;
				bottom: 0.5em;
				width: 1px;
				background: rgba(var(--gray), 0.3);
			}
			.toc li {
				position: relative;
				margin-bottom: 0;
			}
			.toc li::before {
				content: '';
				position: absolute;
				left: 3px;
				top: 50%;
				transform: translateY(-50%);
				width: 7px;
				height: 7px;
				border-radius: 50%;
				background: rgba(var(--gray), 0.4);
				transition: background 0.2s ease;
			}
			.toc li:hover::before {
				background: var(--accent);
			}
			.toc li.toc-h3::before {
				width: 5px;
				height: 5px;
				left: 4px;
			}
			.toc a {
				font-size: 0.875em;
				color: rgb(var(--gray));
				text-decoration: none;
				display: block;
				padding: 0.4em 0.5em 0.4em 1.2em;
				transition: all 0.2s ease;
				line-height: 1.4;
				border-radius: 4px;
			}
			.toc li.toc-h2 a {
				font-weight: 700;
			}
			.toc li.toc-h3 a {
				padding-left: 1.8em;
				font-size: 0.8em;
			}
			.toc a:hover {
				color: var(--accent);
				background: rgba(var(--gray-light), 0.8);
			}
			.toc li.active::before {
				background: var(--accent);
			}
			.toc li.active a {
				color: var(--accent);
			}
			@media (min-width: 920px) {
				.container {
					display: flex;
					justify-content: center;
					align-items: flex-start;
					gap: 2em;
					max-width: 1100px;
				}
				.toc {
					display: block;
				}
			}
		</style>
	</head>

	<body>
		<Header />
		<main>
			<div class="hero-image">
				{heroImage && <Image width={1020} height={510} src={heroImage} alt="" />}
			</div>
			<div class="title">
				<div class="date">
					<FormattedDate date={pubDate} />
					{
						updatedDate && (
							<div class="last-updated-on">
								Last updated on <FormattedDate date={updatedDate} />
							</div>
						)
					}
				</div>
				<BudouX text={title} tag="h1" />
				<hr />
			</div>
			<div class="container">
				<article>
					<div class="prose">
						<slot />
					</div>
				</article>
				{headings.length > 0 && (
					<aside class="toc">
						<nav>
							<h2>目次</h2>
							<ul>
								{headings.map((heading) => (
									<li class={heading.depth === 3 ? 'toc-h3' : 'toc-h2'}>
										<a href={`#${heading.slug}`}>{heading.text}</a>
									</li>
								))}
							</ul>
						</nav>
					</aside>
				)}
			</div>
		</main>
		<Footer />
		<script>
			function updateTocHighlight() {
				const headings = document.querySelectorAll('article h2, article h3');
				const tocLinks = document.querySelectorAll('.toc a');

				if (headings.length === 0 || tocLinks.length === 0) return;

				let currentHeading = '';
				const offset = 100;

				headings.forEach((heading) => {
					const rect = heading.getBoundingClientRect();
					if (rect.top <= offset) {
						currentHeading = heading.id;
					}
				});

				tocLinks.forEach((link) => {
					const href = link.getAttribute('href');
					const li = link.parentElement;
					if (href === `#${currentHeading}`) {
						li?.classList.add('active');
					} else {
						li?.classList.remove('active');
					}
				});
			}

			document.addEventListener('scroll', updateTocHighlight);
			document.addEventListener('DOMContentLoaded', updateTocHighlight);

			// Enable checkbox clicking
			document.querySelectorAll('input[type="checkbox"]').forEach((checkbox) => {
				checkbox.removeAttribute('disabled');
			});
		</script>
	</body>
</html>
